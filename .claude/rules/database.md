# Database Rules

## Prisma

- Always use `npm run db:migrate:dev` to create migrations — NOT `db:push` (which skips migration history)
- After changing `schema.prisma`, run `npm run db:generate` to regenerate the Prisma client
- `db:push` is acceptable for local throwaway prototyping only, before writing the real migration

## pgvector

The `invoice_embeddings` table uses `vector(768)` which Prisma does not natively support.

**All vector operations use raw SQL:**
```typescript
// Insert
await prisma.$executeRaw`
  INSERT INTO invoice_embeddings (parsed_invoice_id, chunk_type, chunk_text, embedding, metadata)
  VALUES (${id}, ${type}, ${text}, ${vectorStr}::vector, ${JSON.stringify(meta)}::jsonb)
  ON CONFLICT DO NOTHING
`;

// Query (cosine similarity)
await prisma.$queryRaw<Row[]>`
  SELECT 1 - (embedding <=> ${vectorStr}::vector) AS similarity
  FROM invoice_embeddings
  ORDER BY embedding <=> ${vectorStr}::vector
  LIMIT ${limit}
`;
```
`vectorStr` format: `[0.123, -0.456, ...]` — generated by `vectorToSql(embedding: number[])`.

Never use `prisma.invoiceEmbedding.create()` or similar — Prisma can't handle the vector type at runtime.

## Raw Queries

- All `$queryRaw` functions in `src/metrics/metrics.ts` return typed arrays — add return type annotations
- Use tagged template literals (`` $queryRaw`...` ``) not `$queryRawUnsafe` — the latter disables parameterization
- Date params: pass as `Date` objects or ISO strings directly — Prisma handles the pg cast

## migrate dev and the HNSW Index

The HNSW index on `invoice_embeddings.embedding` is created by a raw SQL migration but is NOT
declared in `schema.prisma` (Prisma can't represent the `vector` type). This means:

- Running `migrate dev` on an already up-to-date DB will ask for a migration name — **press Ctrl+C**.
  Prisma is seeing the index as drift and would generate a migration to DROP it.
- Only run `migrate dev` after making actual changes to `schema.prisma`.
- To reset the dev DB cleanly: `prisma migrate reset` (applies all migrations incl. HNSW index).

## Pagination

When paginating over a set that shrinks as items are processed (e.g., `parseStatus: 'pending'`):
- Do NOT use `skip: offset` with `offset += batchSize` — processed items leave the filter so you skip live rows
- Always re-fetch from `skip: 0`; the loop breaks naturally when the page returns 0 items

## Connection

- Prisma client is a singleton in `src/db/prisma.ts` via `getPrisma()`
- Never create `new PrismaClient()` directly in application code
- The local database runs on port **5433** (not 5432 — that port belongs to the main serviceup project)
